# Docker Compose configuration for EmmaTresor
# ==========================================
# Defines the multi-container application architecture with:
# - PostgreSQL database for data persistence
# - Django backend API server
# - Nginx reverse proxy with static file serving
#
# This setup provides a production-ready, scalable deployment
# with proper service orchestration and health monitoring.

services:
  # PostgreSQL Database Service
  # =========================
  # Primary data store for the EmmaTresor application.
  # Uses PostgreSQL 16 Alpine for efficiency and security.
  postgres:
    image: postgres:16-alpine                        # Official PostgreSQL 16 Alpine image
    restart: unless-stopped                          # Automatic restart on failure
    env_file: .env                                   # Load environment variables from .env file
    environment:
      POSTGRES_DB: ${POSTGRES_DB}                    # Database name from environment
      POSTGRES_USER: ${POSTGRES_USER}                # Database user from environment
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}        # Database password from environment
    volumes:
      - postgres_data:/var/lib/postgresql/data       # Persistent database storage
      - ./db_backups:/backups                        # Host directory for database backups
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]  # Database readiness check
      interval: 10s                                  # Check every 10 seconds
      timeout: 5s                                    # Timeout after 5 seconds
      retries: 5                                     # Try 5 times before marking unhealthy

  # Django Backend API Service
  # =========================
  # The main application backend running Django with REST Framework.
  # Provides the REST API for the frontend and serves static files.
  backend:
    build:
      context: ./backend                               # Build context is backend folder
      dockerfile: Dockerfile                           # Use backend Dockerfile
    restart: unless-stopped                            # Automatic restart on failure
    env_file: .env                                     # Load environment variables
    environment:
      # Database Configuration
      DB_VENDOR: ${DB_VENDOR}                          # Database type (postgres/sqlite)
      POSTGRES_DB: ${POSTGRES_DB}                      # Database name
      POSTGRES_USER: ${POSTGRES_USER}                  # Database username
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}          # Database password
      POSTGRES_HOST: postgres                          # Internal Docker network hostname
      POSTGRES_PORT: ${POSTGRES_PORT}                  # Database port

      # Django File Storage Paths
      DJANGO_STATIC_ROOT: /vol/web/static              # Static files location
      DJANGO_MEDIA_ROOT: /vol/web/media                # Public media files location
      DJANGO_PRIVATE_MEDIA_ROOT: /vol/web/private_media # Private media files location

    # Service Dependencies
    depends_on:
      postgres:
        condition: service_healthy                     # Wait for database to be ready
        restart: true                                  # Restart backend if database restarts

    # Health Monitoring
    healthcheck:
      test: ["CMD", "python", "manage.py", "check", "--deploy"]  # Django deployment check
      interval: 30s                                    # Check every 30 seconds
      timeout: 10s                                     # Timeout after 10 seconds
      retries: 3                                       # Try 3 times before marking unhealthy
      start_period: 40s                                # Grace period before first health check

    # Data Volumes
    volumes:
      - backend_media:/vol/web/media                   # Public media storage
      - backend_static:/vol/web/static                 # Static files storage
      - backend_private_media:/vol/web/private_media   # Private media storage

    # Network Exposure
    expose:
      - "8000"                                         # Expose port 8000 to other containers

  # Nginx Reverse Proxy & Frontend Service
  # =====================================
  # Serves as the public-facing web server that:
  # - Hosts the React frontend
  # - Reverse-proxies API requests to Django backend
  # - Serves static and media files efficiently
  nginx:
    build:
      context: .                                      # Build context is project root
      dockerfile: docker/nginx/Dockerfile            # Use custom Nginx Dockerfile
    restart: unless-stopped                            # Automatic restart on failure
    env_file: .env                                     # Load environment variables

    # Service Dependencies
    depends_on:
      - backend                                       # Wait for backend to be ready

    # External Network Exposure
    ports:
      - "127.0.0.1:8888:80"                                     # Expose port 8888 to host machine (mapped to container port 80)

    # Data Volumes (read-only for security)
    volumes:
      - backend_static:/var/www/emmatresor/static:ro  # Static files (read-only)
      - backend_media:/var/www/emmatresor/media:ro    # Public media files (read-only)

# =========================
# PERSISTENT DATA VOLUMES
# =========================
# Docker-managed volumes for persistent data storage.
# These volumes survive container restarts and recreation.

volumes:
  postgres_data:                                     # Database files
  backend_static:                                    # Django static files (CSS, JS, images)
  backend_media:                                     # User-uploaded public media files
  backend_private_media:                             # User-uploaded private media files
