##
# Sample host-level Nginx config for EmmaTresor
#
# Copy to /etc/nginx/sites-available/emmatresor and symlink into
# /etc/nginx/sites-enabled/. Adjust `server_name` and TLS settings
# for your deployment. This server expects the docker-compose stack
# to publish the bundled Nginx on 127.0.0.1:8888.
##

limit_req_zone $binary_remote_addr zone=emmatresor_api:10m rate=40r/s;
limit_req_zone $binary_remote_addr zone=emmatresor_login:10m rate=20r/s;
limit_req_zone $binary_remote_addr zone=emmatresor_register:10m rate=10r/s;

server {
    listen 80;
    server_name emmatresor.example.com;

    set $csp_policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data:; connect-src 'self'; frame-ancestors 'self'; base-uri 'self'; object-src 'none'";
    add_header Content-Security-Policy "$csp_policy" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    location /health/ {
        proxy_pass http://127.0.0.1:8888/health/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_redirect off;
        access_log off;
    }

    location ~ ^/api/(token|auth/) {
        limit_req zone=emmatresor_login burst=50 nodelay;
        proxy_pass http://127.0.0.1:8888;
        include proxy_params;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_redirect off;
    }

    location = /api/users/ {
        limit_req zone=emmatresor_register burst=50 nodelay;
        proxy_pass http://127.0.0.1:8888;
        include proxy_params;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_redirect off;
    }

    location / {
        proxy_pass http://127.0.0.1:8888;
        include proxy_params;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host;
        proxy_redirect off;
    }
}
